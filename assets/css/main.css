(function() {
  'use strict';

  // ==================== MOBILE MENU ====================
  class MobileMenu {
    constructor() {
      this.toggle = document.querySelector('.mobile-menu-toggle');
      this.nav = document.querySelector('.mobile-nav');
      if (!this.toggle || !this.nav) return;

      this.toggle.addEventListener('click', () => this.toggleMenu());
    }

    toggleMenu() {
      this.nav.classList.toggle('active');
      this.toggle.classList.toggle('active');
    }
  }

  // ==================== LIGHTBOX ====================
  class Lightbox {
    constructor() {
      this.lightbox = document.querySelector('.lightbox');
      if (!this.lightbox) return;

      this.overlay = this.lightbox.querySelector('.lightbox-overlay');
      this.image = this.lightbox.querySelector('.lightbox-image');
      this.caption = this.lightbox.querySelector('.lightbox-caption');
      this.closeBtn = this.lightbox.querySelector('.lightbox-close');
      this.prevBtn = this.lightbox.querySelector('.lightbox-prev');
      this.nextBtn = this.lightbox.querySelector('.lightbox-next');
      this.counter = this.lightbox.querySelector('.lightbox-counter');

      this.images = [];
      this.currentIndex = 0;

      this.init();
    }

    init() {
      this.images = Array.from(document.querySelectorAll('[data-lightbox]'));
      if (!this.images.length) return;

      this.images.forEach((img, index) => {
        img.style.cursor = 'pointer';
        img.addEventListener('click', () => this.open(index));
      });

      this.closeBtn?.addEventListener('click', () => this.close());
      this.overlay?.addEventListener('click', () => this.close());
      this.prevBtn?.addEventListener('click', () => this.prev());
      this.nextBtn?.addEventListener('click', () => this.next());

      document.addEventListener('keydown', (e) => {
        if (!this.lightbox.classList.contains('active')) return;
        if (e.key === 'Escape') this.close();
        if (e.key === 'ArrowLeft') this.prev();
        if (e.key === 'ArrowRight') this.next();
      });
    }

    open(index) {
      this.currentIndex = index;
      this.updateImage();
      this.lightbox.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    close() {
      this.lightbox.classList.remove('active');
      document.body.style.overflow = '';
    }

    prev() {
      this.currentIndex = (this.currentIndex - 1 + this.images.length) % this.images.length;
      this.updateImage();
    }

    next() {
      this.currentIndex = (this.currentIndex + 1) % this.images.length;
      this.updateImage();
    }

    updateImage() {
      const img = this.images[this.currentIndex];
      if (!img) return;

      this.image.src = img.src;
      this.image.alt = img.alt || '';
      this.caption.textContent = img.alt || '';
      if (this.counter) this.counter.textContent = `${this.currentIndex + 1} / ${this.images.length}`;

      const showNav = this.images.length > 1;
      if (this.prevBtn) this.prevBtn.style.display = showNav ? '' : 'none';
      if (this.nextBtn) this.nextBtn.style.display = showNav ? '' : 'none';
    }
  }

  // ==================== CATEGORIES ACCORDION ====================
  class CategoriesAccordion {
    constructor() {
      document.querySelectorAll('.category-header').forEach(header => {
        const group = header.closest('.category-group');
        if (!group) return;
        // по умолчанию все кроме id "politika" открыты
        if (group.id !== 'politika') group.classList.add('open');

        header.addEventListener('click', () => group.classList.toggle('open'));
      });
    }
  }

  // ==================== FAVORITES CAROUSEL ====================
  class FavoritesCarousel {
    constructor(trackSelector) {
      this.track = document.querySelector(trackSelector);
      if (!this.track) return;

      this.isDown = false;
      this.startX = 0;
      this.scrollLeft = 0;

      // MOUSE EVENTS
      this.track.addEventListener('mousedown', (e) => {
        this.isDown = true;
        this.track.classList.add('dragging');
        this.startX = e.pageX - this.track.offsetLeft;
        this.scrollLeft = this.track.scrollLeft;
      });

      this.track.addEventListener('mouseleave', () => {
        this.isDown = false;
        this.track.classList.remove('dragging');
      });

      this.track.addEventListener('mouseup', () => {
        this.isDown = false;
        this.track.classList.remove('dragging');
      });

      this.track.addEventListener('mousemove', (e) => {
        if (!this.isDown) return;
        e.preventDefault();
        const x = e.pageX - this.track.offsetLeft;
        const walk = (x - this.startX) * 2; // скорость прокрутки
        this.track.scrollLeft = this.scrollLeft - walk;
      });

      // TOUCH EVENTS
      let touchStartX = 0;
      let scrollStartX = 0;

      this.track.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        scrollStartX = this.track.scrollLeft;
      }, { passive: true });

      this.track.addEventListener('touchmove', (e) => {
        const x = e.touches[0].clientX;
        const walk = (touchStartX - x) * 2;
        this.track.scrollLeft = scrollStartX + walk;
      }, { passive: true });
    }
  }

  // ==================== INIT ====================
  document.addEventListener('DOMContentLoaded', () => {
    new MobileMenu();
    new Lightbox();
    new CategoriesAccordion();
    new FavoritesCarousel('.favorites-track');
  });
})();
